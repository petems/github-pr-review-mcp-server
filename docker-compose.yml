version: '3.8'

services:
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: github-pr-review-mcp:latest
    container_name: mcp-pr-review
    ports:
      - "8080:8080"
    environment:
      # Server Configuration
      - MCP_MODE=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8080

      # Authentication (set these!)
      - MCP_SECRET_KEY=${MCP_SECRET_KEY:?MCP_SECRET_KEY must be set}
      - MCP_ADMIN_TOKEN=${MCP_ADMIN_TOKEN:-}

      # GitHub Configuration (optional - can use per-user tokens)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}

      # Rate Limiting
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_REQUESTS_PER_MINUTE=60
      - RATE_LIMIT_BURST=10

      # CORS
      - CORS_ENABLED=true
      - CORS_ALLOW_ORIGINS=*
      - CORS_ALLOW_CREDENTIALS=true

      # Logging
      - LOG_LEVEL=INFO

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    restart: unless-stopped

    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Security
    security_opt:
      - no-new-privileges:true
    read_only: false
    user: appuser

  # Optional: nginx reverse proxy for SSL termination
  # nginx:
  #   image: nginx:alpine
  #   container_name: mcp-nginx
  #   ports:
  #     - "443:443"
  #     - "80:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - mcp-server
  #   restart: unless-stopped
